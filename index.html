<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Inventario Futurista - Escanea y Guarda</title>
  <meta name="description" content="Escanea códigos, añade precios al por mayor y por unidad, guarda y descarga la lista. Contacto WhatsApp incluido." />
  <style>
    :root{
      --bg:#05060a;
      --glass: rgba(255,255,255,0.04);
      --accent:#6ef0ff;
      --accent-2:#9b7bff;
      --muted:rgba(255,255,255,0.6);
      --neon: 0 0 18px rgba(110,240,255,0.14), 0 0 48px rgba(155,123,255,0.06);
      --glass-border: rgba(255,255,255,0.06);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#02020a 0%, #071224 60%);color:#eaf6ff}
    .wrap{max-width:1100px;margin:28px auto;padding:20px;}

    header{display:flex;gap:16px;align-items:center;justify-content:space-between}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:56px;height:56px;border-radius:14px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;box-shadow:var(--neon)}
    .logo svg{width:34px;height:34px;fill:#041022}
    h1{font-size:18px;margin:0}
    p.lead{margin:0;color:var(--muted);font-size:13px}

    main{display:grid;grid-template-columns:1fr 420px;gap:18px;margin-top:18px}

    /* Left panel */
    .panel{background:linear-gradient(180deg,rgba(255,255,255,0.02),var(--glass));border-radius:14px;padding:16px;border:1px solid var(--glass-border);box-shadow:0 6px 30px rgba(3,6,16,0.5)}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    .btn{background:transparent;border:1px solid rgba(255,255,255,0.08);padding:10px 12px;border-radius:10px;color:var(--accent);cursor:pointer;backdrop-filter: blur(6px);}
    .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#041022;border:none;box-shadow:var(--neon)}
    .btn.ghost{color:var(--muted)}

    .video-wrap{position:relative;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,0.03)}
    video, canvas{width:100%;height:100%;display:block;min-height:260px;background:#000}
    .scan-overlay{position:absolute;inset:0;pointer-events:none;display:flex;align-items:center;justify-content:center}
    .reticle{width:64%;height:48%;border:2px dashed rgba(110,240,255,0.18);border-radius:8px;box-shadow:0 0 48px rgba(110,240,255,0.03), inset 0 0 30px rgba(155,123,255,0.01)}
    .status{margin-top:10px;font-size:13px;color:var(--muted)}

    form.item-form{display:grid;grid-template-columns:1fr 120px;gap:8px;margin-top:12px}
    .item-form .full{grid-column:1/-1}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input[type=text], input[type=number], textarea, select{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}

    .list{margin-top:12px;max-height:420px;overflow:auto;padding-right:8px}
    .product{display:flex;align-items:center;gap:12px;padding:10px;border-radius:10px;margin-bottom:8px;border:1px solid rgba(255,255,255,0.03);background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent)}
    .product .meta{flex:1}
    .product .meta b{display:block}
    .product small{color:var(--muted);display:block}
    .product .actions{display:flex;gap:8px}
    .pill{background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:8px;font-size:12px}

    /* Right panel */
    aside{display:flex;flex-direction:column;gap:12px}
    .card{padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent)}
    .whatsapp{display:flex;gap:10px;align-items:center}
    .whatsapp a{display:inline-flex;align-items:center;gap:8px;padding:10px;border-radius:10px;text-decoration:none;background:linear-gradient(90deg,#25D366,#128C7E);color:#fff}

    footer{margin-top:18px;text-align:center;color:var(--muted);font-size:12px}

    @media (max-width:980px){main{grid-template-columns:1fr}aside{order:2}header{flex-direction:column;align-items:flex-start} .video-wrap video{min-height:220px}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden>
          <svg viewBox="0 0 24 24"><path d="M3 12l4-8 14 8-14 8-4-8z"/></svg>
        </div>
        <div>
          <h1>Inventario Futurista</h1>
          <p class="lead">Escanea códigos, añade precios por mayor y unidad. Descarga tu lista cuando quieras.</p>
        </div>
      </div>
      <div>
        <button id="downloadBtn" class="btn primary">Descargar lista (CSV)</button>
      </div>
    </header>

    <main>
      <section class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="display:flex;gap:8px">
            <button id="startCam" class="btn">Abrir Cámara</button>
            <button id="snap" class="btn ghost">Tomar Foto</button>
            <label class="btn" style="cursor:pointer">
              <input id="fileInput" type="file" accept="image/*" style="display:none"> Subir imagen
            </label>
          </div>
          <div style="text-align:right;color:var(--muted);font-size:12px">Tú WhatsApp: <b>+593986122265</b></div>
        </div>

        <div class="video-wrap" style="margin-top:12px">
          <video id="video" autoplay playsinline></video>
          <canvas id="canvas" style="display:none"></canvas>
          <div class="scan-overlay"><div class="reticle"></div></div>
        </div>
        <div class="status" id="status">Estado: listo</div>

        <form id="productForm" class="item-form" onsubmit="return false;">
          <div class="full">
            <label for="code">Código / SKU (escaneado o manual)</label>
            <input id="code" type="text" placeholder="Escanea o escribe el código" autocomplete="off">
          </div>
          <div class="full">
            <label for="name">Concepto / Nombre del producto</label>
            <input id="name" type="text" placeholder="Ej: Camisa deportiva - talla M">
          </div>
          <div>
            <label for="wholesale">Precio al por mayor</label>
            <input id="wholesale" type="number" min="0" step="0.01" placeholder="0.00">
          </div>
          <div>
            <label for="unit">Precio por unidad</label>
            <input id="unit" type="number" min="0" step="0.01" placeholder="0.00">
          </div>

          <div class="full" style="display:flex;gap:8px">
            <button id="addBtn" class="btn primary">Agregar producto</button>
            <button id="clearBtn" class="btn">Limpiar campos</button>
          </div>
        </form>

        <div class="list panel" id="productList" aria-live="polite"></div>

        <div style="display:flex;gap:8px;margin-top:10px">
          <button id="clearAll" class="btn">Borrar todo</button>
          <button id="exportJson" class="btn">Exportar JSON</button>
        </div>
      </section>

      <aside>
        <div class="card">
          <h3 style="margin:0 0 8px 0">Soporte y contacto</h3>
          <div class="whatsapp">
            <a id="waLink" href="#" target="_blank" rel="noopener noreferrer">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden>
                <path d="M20.5 3.5L3.5 20.5" stroke="white" stroke-width="0"/>
                <path fill="#fff" d="M12.04 2C6.5 2 2 6.48 2 12.02c0 2.12.61 4.09 1.66 5.77L2 22l4.42-1.46c1.59.86 3.42 1.33 5.62 1.33 5.54 0 10.04-4.48 10.04-9.98C22.08 6.48 17.58 2 12.04 2z"/>
              </svg>
              Contactar por WhatsApp
            </a>
          </div>
          <p style="margin-top:10px;color:var(--muted);font-size:13px">Incluye tu número de WhatsApp para que los clientes te escriban directamente.</p>
        </div>

        <div class="card">
          <h4 style="margin:0 0 8px 0">Instrucciones rápidas</h4>
          <ol style="margin:0;padding-left:18px;color:var(--muted)">
            <li>Permite el uso de la cámara cuando el navegador lo solicite.</li>
            <li>Usa "Tomar Foto" o "Subir imagen" si tu navegador no soporta lectura de códigos.</li>
            <li>Agrega los precios y pulsa "Agregar producto".</li>
            <li>Descarga la lista con "Descargar lista (CSV)" o "Exportar JSON".</li>
          </ol>
        </div>

        <div class="card">
          <h4 style="margin:0 0 8px 0">Privacidad</h4>
          <p style="margin:0;color:var(--muted);font-size:13px">Los datos se guardan en tu navegador (localStorage). No se suben a servidores externos.</p>
        </div>
      </aside>
    </main>

    <footer>
      <small>Diseño futurista • Responsive • Guarda y descarga tu inventario fácilmente</small>
    </footer>
  </div>

  <script>
    // Datos y selectores
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const status = document.getElementById('status');
    const startCam = document.getElementById('startCam');
    const snap = document.getElementById('snap');
    const fileInput = document.getElementById('fileInput');
    const codeInp = document.getElementById('code');
    const nameInp = document.getElementById('name');
    const wholesaleInp = document.getElementById('wholesale');
    const unitInp = document.getElementById('unit');
    const addBtn = document.getElementById('addBtn');
    const clearBtn = document.getElementById('clearBtn');
    const productList = document.getElementById('productList');
    const downloadBtn = document.getElementById('downloadBtn');
    const clearAll = document.getElementById('clearAll');
    const exportJson = document.getElementById('exportJson');
    const waLink = document.getElementById('waLink');

    // Número de WhatsApp provisto por el usuario
    const WHATSAPP_NUMBER = '+593986122265';
    waLink.href = `https://wa.me/${WHATSAPP_NUMBER.replace(/\D/g,'')}`;

    let stream = null;
    let products = JSON.parse(localStorage.getItem('inventario_futurista_v1')||'[]');

    // Guardar/Actualizar UI
    function saveProducts(){
      localStorage.setItem('inventario_futurista_v1', JSON.stringify(products));
      renderList();
    }

    function renderList(){
      productList.innerHTML = '';
      if(products.length===0){ productList.innerHTML = '<p style="color:var(--muted)">No hay productos guardados.</p>'; return }
      products.slice().reverse().forEach((p,idx)=>{
        const el = document.createElement('div'); el.className='product';
        el.innerHTML = `
          <div class="meta">
            <b>${p.name || '(sin nombre)'}</b>
            <small>${p.code? 'Código: '+p.code : ''}</small>
            <small class="pill">Mayor: ${formatMoney(p.wholesale)} • Unidad: ${formatMoney(p.unit)}</small>
            <small style="color:var(--muted)">${p.note||''}</small>
          </div>
          <div class="actions">
            <button class="btn" data-idx="${products.length-1-idx}" onclick="editProduct(event)">Editar</button>
            <button class="btn" data-idx="${products.length-1-idx}" onclick="removeProduct(event)">Borrar</button>
          </div>
        `;
        productList.appendChild(el);
      });
    }

    function formatMoney(v){ if(!v && v!==0) return '-'; return Number(v).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}) }

    // Add product
    addBtn.addEventListener('click',()=>{
      const code = codeInp.value.trim();
      const name = nameInp.value.trim();
      const wholesale = wholesaleInp.value? parseFloat(wholesaleInp.value) : null;
      const unit = unitInp.value? parseFloat(unitInp.value) : null;
      if(!name && !code){ alert('Por favor agrega al menos un código o nombre.'); return }
      const product = { id: Date.now(), code, name, wholesale, unit, note: '' };
      products.push(product);
      saveProducts();
      status.textContent = 'Producto agregado ✅';
      // limpiar campos
      codeInp.value=''; nameInp.value=''; wholesaleInp.value=''; unitInp.value='';
    });

    clearBtn.addEventListener('click',()=>{ codeInp.value=''; nameInp.value=''; wholesaleInp.value=''; unitInp.value=''; status.textContent='Campos limpiados'; });

    clearAll.addEventListener('click',()=>{
      if(!confirm('¿Borrar todos los productos guardados?')) return;
      products = [];
      saveProducts();
      status.textContent='Lista vaciada';
    });

    exportJson.addEventListener('click',()=>{
      const blob = new Blob([JSON.stringify(products, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='inventario.json'; a.click(); URL.revokeObjectURL(url);
    });

    downloadBtn.addEventListener('click',()=>{
      if(products.length===0){ alert('No hay productos para descargar.'); return }
      const rows = [['id','code','name','wholesale','unit','note']];
      products.forEach(p=>rows.push([p.id,p.code,p.name,p.wholesale,p.unit,p.note]));
      const csv = rows.map(r=>r.map(c=>`"${String(c||'').replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv],{type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='inventario.csv'; a.click(); URL.revokeObjectURL(url);
    });

    function removeProduct(e){ const i = Number(e.currentTarget.dataset.idx); products.splice(i,1); saveProducts(); status.textContent='Producto borrado'; }
    function editProduct(e){ const i = Number(e.currentTarget.dataset.idx); const p = products[i]; codeInp.value=p.code; nameInp.value=p.name; wholesaleInp.value=p.wholesale; unitInp.value=p.unit; status.textContent='Editando producto — modifica y pulsa Agregar para crear uno nuevo o limpia para cancelar'; }

    // Camera + scanning
    startCam.addEventListener('click',async()=>{
      if(stream){ // detener
        stopCam(); startCam.textContent='Abrir Cámara'; return;
      }
      try{
        stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
        video.srcObject = stream;
        startCam.textContent='Cerrar Cámara';
        status.textContent='Cámara activa — intentando detectar códigos...';
        requestAnimationFrame(scanFrame);
      }catch(err){ console.error(err); status.textContent='No se pudo acceder a la cámara: '+err.message }
    });

    snap.addEventListener('click',()=>{
      if(!stream){ status.textContent='Abre la cámara primero.'; return }
      takePhotoAndScan();
    });

    fileInput.addEventListener('change',async(e)=>{
      const file = e.target.files[0]; if(!file) return;
      const img = new Image(); img.src = URL.createObjectURL(file);
      img.onload = ()=>{ scanImageElement(img); URL.revokeObjectURL(img.src); }
    });

    async function takePhotoAndScan(){
      canvas.width = video.videoWidth; canvas.height = video.videoHeight; const ctx = canvas.getContext('2d'); ctx.drawImage(video,0,0,canvas.width,canvas.height);
      const img = new Image(); img.src = canvas.toDataURL('image/png'); img.onload = ()=> scanImageElement(img);
    }

    async function scanImageElement(img){
      status.textContent='Analizando imagen...';
      // Si el navegador soporta BarcodeDetector
      if('BarcodeDetector' in window){
        try{
          const formats = await BarcodeDetector.getSupportedFormats();
          const detector = new BarcodeDetector({formats});
          const results = await detector.detect(img);
          if(results && results.length){
            const code = results[0].rawValue;
            codeInp.value = code; status.textContent='Código detectado: '+code;
            return;
          }else{ status.textContent='No se detectó ningún código en la imagen.' }
        }catch(err){ console.warn('BarcodeDetector err',err); status.textContent='Error al intentar detectar: '+err.message }
      }
      status.textContent+=' (tu navegador no soporta BarcodeDetector — ingresa el código manualmente)';
    }

    async function scanFrame(){
      if(!stream) return;
      try{
        if('BarcodeDetector' in window){
          const detector = new BarcodeDetector();
          // dibujar frame pequeño
          canvas.width = video.videoWidth; canvas.height = video.videoHeight; const ctx = canvas.getContext('2d'); ctx.drawImage(video,0,0,canvas.width,canvas.height);
          const results = await detector.detect(canvas);
          if(results && results.length){ const code = results[0].rawValue; codeInp.value = code; status.textContent='Detectado: '+code; }
        }
      }catch(e){ /* no hacer nada */ }
      requestAnimationFrame(scanFrame);
    }

    function stopCam(){ if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; video.srcObject=null; status.textContent='Cámara detenida'; } }

    // Inicializar
    (function init(){ renderList(); // si el navegador no soporta BarcodeDetector, mostrar nota
      if(!('BarcodeDetector' in window)){
        status.textContent = 'Nota: Tu navegador no soporta lectura automática de códigos. Usa "Subir imagen" o ingresa el código manualmente.';
      }
    })();

    // Permitir usar las funciones desde HTML inline (editar/borrar botones usan estas)
    window.removeProduct = removeProduct; window.editProduct = editProduct;
  </script>
</body>
</html>
